---
id: 138248
author: Colin Eberhardt
tags: 
- Windows Phone 7
categories: 
- Blog
layout: ceberhardt_post
---

<p>Last night, with my Christmas presents all wrapped and a lack of any decent programmes (festive or otherwise) on television, I had a few hours to kill, so decided to create a festive-themed WP7 game &#8230;</p>
<p>Ever since I first started writing code for Windows Phone 7 I have wanted to do something involving physics and the accelerometer. I finally found a few hours to spare to give it a go. This blog post doesn't go into too much detail about <a href="http://farseerphysics.codeplex.com/">Farseer</a>, the Physics Engine that I used, I didn't really have time to learn it in any great detail. This post is more about how quickly you can put together something really quite cool in quite a short space of time using libraries and code grabbed from the internet.</p>
<p>The simple app I created renders a maze that you 'roll' a small ball around by tilting your phone:</p>
<p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/12/MazeGame.png" alt="" title="MazeGame" width="200" height="363" class="aligncenter size-full wp-image-1900" /></p>
<p>This works well in the new 7.1 emulator where you can tilt the emulator via the extended controls. However, it works best on a real device, where you can control tilt far more easily. See the video below:</p>
<p><iframe width="480" height="360" src="http://www.youtube.com/embed/Xkhh9P-Y45k" frameborder="0" allowfullscreen></iframe></p>
<h2>Farseer Physics Engine</h2>
<p>The game makes use of the popular <a href="http://farseerphysics.codeplex.com/">Farseer Physics Engine</a>. This library allows you to create a world populated with physics bodies, supporting features such as friction, joints, motors and much much more. As I am a Silverlight developer I made use of the <a href="http://physicshelper.codeplex.com/">Physics Helper</a> library which allows you to use the Farseer engine within a Silvelight application with very little effort. With the Physics Helper you simply make the Physics Engine 'aware' of the objects you wish it to control and it does the rest, animating them as they are subjected to gravity and other interactions.</p>
<p>The simplest way to use Physics Helper is via behaviours, this allows you to create a fully functioning 'world' without writing a single line of C# code. For example, you can create a ball and a surface that it will fall towards, eventually coming to rest, with just a few lines of XAML:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #008000;">&lt;</span>Canvas x<span style="color: #008000;">:</span>Name<span style="color: #008000;">=</span><span style="color: #666666;">&quot;canvas&quot;</span><span style="color: #008000;">&gt;</span>
  <span style="color: #008000;">&lt;!--</span> create our <span style="color: #666666;">'world'</span> <span style="color: #008000;">--&gt;</span>
  <span style="color: #008000;">&lt;</span>i<span style="color: #008000;">:</span>Interaction<span style="color: #008000;">.</span><span style="color: #0000FF;">Behaviors</span><span style="color: #008000;">&gt;</span>
    <span style="color: #008000;">&lt;</span>pb<span style="color: #008000;">:</span>PhysicsControllerBehavior<span style="color: #008000;">/&gt;</span>
  <span style="color: #008000;">&lt;/</span>i<span style="color: #008000;">:</span>Interaction<span style="color: #008000;">.</span><span style="color: #0000FF;">Behaviors</span><span style="color: #008000;">&gt;</span>
&nbsp;
  <span style="color: #008000;">&lt;</span>Ellipse Width<span style="color: #008000;">=</span><span style="color: #666666;">&quot;100&quot;</span> Height<span style="color: #008000;">=</span><span style="color: #666666;">&quot;100&quot;</span> Fill<span style="color: #008000;">=</span><span style="color: #666666;">&quot;Red&quot;</span>
            Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">Left</span><span style="color: #008000;">=</span><span style="color: #666666;">&quot;80&quot;</span> Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">Top</span><span style="color: #008000;">=</span><span style="color: #666666;">&quot;100&quot;</span><span style="color: #008000;">&gt;</span>
    <span style="color: #008000;">&lt;!--</span> make the engine aware of <span style="color: #0600FF; font-weight: bold;">this</span> element <span style="color: #008000;">--&gt;</span>
    <span style="color: #008000;">&lt;</span>i<span style="color: #008000;">:</span>Interaction<span style="color: #008000;">.</span><span style="color: #0000FF;">Behaviors</span><span style="color: #008000;">&gt;</span>
      <span style="color: #008000;">&lt;</span>pb<span style="color: #008000;">:</span>PhysicsObjectBehavior <span style="color: #008000;">/&gt;</span>
    <span style="color: #008000;">&lt;/</span>i<span style="color: #008000;">:</span>Interaction<span style="color: #008000;">.</span><span style="color: #0000FF;">Behaviors</span><span style="color: #008000;">&gt;</span>
  <span style="color: #008000;">&lt;/</span>Ellipse<span style="color: #008000;">&gt;</span>
&nbsp;
&nbsp;
  <span style="color: #008000;">&lt;</span>Rectangle Width<span style="color: #008000;">=</span><span style="color: #666666;">&quot;500&quot;</span> Height<span style="color: #008000;">=</span><span style="color: #666666;">&quot;10&quot;</span> Fill<span style="color: #008000;">=</span><span style="color: #666666;">&quot;Blue&quot;</span>
              Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">Top</span><span style="color: #008000;">=</span><span style="color: #666666;">&quot;500&quot;</span><span style="color: #008000;">&gt;</span>
    <span style="color: #008000;">&lt;!--</span> make the engine aware of <span style="color: #0600FF; font-weight: bold;">this</span> <span style="color: #0600FF; font-weight: bold;">STATIC</span> element <span style="color: #008000;">--&gt;</span>
    <span style="color: #008000;">&lt;</span>i<span style="color: #008000;">:</span>Interaction<span style="color: #008000;">.</span><span style="color: #0000FF;">Behaviors</span><span style="color: #008000;">&gt;</span>
      <span style="color: #008000;">&lt;</span>pb<span style="color: #008000;">:</span>PhysicsObjectBehavior IsStatic<span style="color: #008000;">=</span><span style="color: #666666;">&quot;True&quot;</span><span style="color: #008000;">/&gt;</span>
    <span style="color: #008000;">&lt;/</span>i<span style="color: #008000;">:</span>Interaction<span style="color: #008000;">.</span><span style="color: #0000FF;">Behaviors</span><span style="color: #008000;">&gt;</span>
  <span style="color: #008000;">&lt;/</span>Rectangle<span style="color: #008000;">&gt;</span>
<span style="color: #008000;">&lt;/</span>Canvas<span style="color: #008000;">&gt;</span>{% endhighlight %}
</div>
</div>
<p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/12/SimpleExample.png" alt="" title="SimpleExample" width="600" height="256" class="aligncenter size-full wp-image-1901" /></p>
<p>I find this pretty amazing! </p>
<p>Physics Helper will do much more, it can handle complex paths and geometries, explosions and collisions with minimal effort. For a greater insight into just how much is possible, I would recommend <a href="http://channel9.msdn.com/coding4fun/articles/Creating-a-Pinball-Game-in-Silverlight-Using-the-Physics-Helper-Library--Farseer-Physics">Andy Beaulieu's Channel 9 article</a>. Andy is the creator of Farseer, so really knows his stuff!</p>
<p>My maze is generated in C# code, so despite the elegance of using Physics Helper via behaviours, I need to add elements to my canvas programmatically. This means that I have to make the physics engine aware of their existence in code also. To achieve this, I add the behaviour in code as follows:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Uses Physics Helper to create a physics body for the given element</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> AddPhysicsBody<span style="color: #008000;">&#40;</span>FrameworkElement element, <span style="color: #6666cc; font-weight: bold;">bool</span> isStatic<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  var behaviorCollection <span style="color: #008000;">=</span> Interaction<span style="color: #008000;">.</span><span style="color: #0000FF;">GetBehaviors</span><span style="color: #008000;">&#40;</span>element<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  behaviorCollection<span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">new</span> PhysicsObjectBehavior<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
  <span style="color: #008000;">&#123;</span>
    IsStatic <span style="color: #008000;">=</span> isStatic
  <span style="color: #008000;">&#125;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&nbsp;
  var physicsObject <span style="color: #008000;">=</span> element<span style="color: #008000;">.</span><span style="color: #0000FF;">GetValue</span><span style="color: #008000;">&#40;</span>PhysicsObjectMain<span style="color: #008000;">.</span><span style="color: #0000FF;">PhysicsObjectProperty</span><span style="color: #008000;">&#41;</span> <span style="color: #0600FF; font-weight: bold;">as</span> PhysicsObjectMain<span style="color: #008000;">;</span>
  _physicsController<span style="color: #008000;">.</span><span style="color: #0000FF;">AddPhysicsBody</span><span style="color: #008000;">&#40;</span>physicsObject<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<h2>Creating a Maze</h2>
<p>I found numerous C# maze algorithms on the internet, most of them based on the same random-walk concept. There is a great description of this approach, with <a href="http://weblog.jamisbuck.org/2011/1/20/maze-generation-wilson-s-algorithm">animated examples on this blog</a>. Unfortunately every C# implementation I came across was tightly coupled to a specific UI framework, often WinForms or XNA (tut-tut remember to separate your concerns!). So, I took a simple maze algorithm <a href="http://www.techpowerup.com/forums/showthread.php?t=109739">from a software forum</a> and ripped-out the WinForms / GDI rendering code. A new maze is constructed simply by creating an instance of the <code>Maze</code> class, passing it the number of rows and columns.</p>
<p>In order to render the maze using Silverlight elements, I simply took the original maze graphics code:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> CreateMaze<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  <span style="color: #008080; font-style: italic;">// compute the number of rows / cols</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> ratio <span style="color: #008000;">=</span> mazeContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span> <span style="color: #008000;">/</span> mazeContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualWidth</span><span style="color: #008000;">;</span>
  <span style="color: #6666cc; font-weight: bold;">int</span> cols <span style="color: #008000;">=</span> _mazeSize<span style="color: #008000;">;</span>
  <span style="color: #6666cc; font-weight: bold;">int</span> rows <span style="color: #008000;">=</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">int</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&#41;</span>cols <span style="color: #008000;">*</span> ratio<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> cellWidth <span style="color: #008000;">=</span> mazeContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualWidth</span> <span style="color: #008000;">/</span> cols<span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// create the maze</span>
  Maze maze <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> Maze<span style="color: #008000;">&#40;</span>rows, cols<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// render the maze</span>
  <span style="color: #0600FF; font-weight: bold;">for</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">int</span> i <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span> i <span style="color: #008000;">&lt;</span> cols<span style="color: #008000;">;</span> <span style="color: #008000;">++</span>i<span style="color: #008000;">&#41;</span>
  <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">for</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">int</span> j <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span> j <span style="color: #008000;">&lt;</span> rows<span style="color: #008000;">;</span> <span style="color: #008000;">++</span>j<span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
      var room <span style="color: #008000;">=</span> maze<span style="color: #008000;">.</span><span style="color: #0000FF;">cells</span><span style="color: #008000;">&#91;</span>i, j<span style="color: #008000;">&#93;</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span>room <span style="color: #008000;">&amp;</span> Maze<span style="color: #008000;">.</span><span style="color: #0000FF;">UP</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">!=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">&#41;</span>
        DrawLine<span style="color: #008000;">&#40;</span>i <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span>,
                j <span style="color: #008000;">*</span> cellWidth,
                i <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span>,
                j <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span> <span style="color: #008000;">-</span> <span style="color: #FF0000;">1</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span>room <span style="color: #008000;">&amp;</span> Maze<span style="color: #008000;">.</span><span style="color: #0000FF;">DOWN</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">!=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">&#41;</span>
        DrawLine<span style="color: #008000;">&#40;</span>i <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span>,
              j <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span>,
              i <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span>,
              j <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">-</span> <span style="color: #FF0000;">1</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span>room <span style="color: #008000;">&amp;</span> Maze<span style="color: #008000;">.</span><span style="color: #0000FF;">RIGHT</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">!=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">&#41;</span>
        DrawLine<span style="color: #008000;">&#40;</span>i <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span>,
              j <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span>,
              i <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">-</span> <span style="color: #FF0000;">1</span>,
              j <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span>room <span style="color: #008000;">&amp;</span> Maze<span style="color: #008000;">.</span><span style="color: #0000FF;">LEFT</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">!=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">&#41;</span>
        DrawLine<span style="color: #008000;">&#40;</span>i <span style="color: #008000;">*</span> cellWidth,
              j <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span>,
              i <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span> <span style="color: #008000;">-</span> <span style="color: #FF0000;">1</span>,
              j <span style="color: #008000;">*</span> cellWidth <span style="color: #008000;">+</span> cellWidth <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
  <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<p>And created a method that mimics the behaviour of the <code>System.Drawing.Graphics.DrawLine</code> method which the original maze code depended on:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> DrawLine<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">double</span> x1, <span style="color: #6666cc; font-weight: bold;">double</span> y1, <span style="color: #6666cc; font-weight: bold;">double</span> x2, <span style="color: #6666cc; font-weight: bold;">double</span> y2<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> width <span style="color: #008000;">=</span> x2 <span style="color: #008000;">-</span> x1 <span style="color: #008000;">+</span> <span style="color: #FF0000;">2.0</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>width <span style="color: #008000;">==</span> <span style="color: #FF0000;">0.0</span><span style="color: #008000;">&#41;</span> width <span style="color: #008000;">=</span> <span style="color: #FF0000;">2.0</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #6666cc; font-weight: bold;">double</span> height <span style="color: #008000;">=</span>  y2 <span style="color: #008000;">-</span> y1<span style="color: #008000;">+</span> <span style="color: #FF0000;">2.0</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>height <span style="color: #008000;">==</span> <span style="color: #FF0000;">0.0</span><span style="color: #008000;">&#41;</span> height <span style="color: #008000;">=</span> <span style="color: #FF0000;">2.0</span><span style="color: #008000;">;</span>
&nbsp;
  var rec <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> <span style="color: #000000;">System</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Windows</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Shapes</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Rectangle</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
  <span style="color: #008000;">&#123;</span>
    Fill <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> SolidColorBrush<span style="color: #008000;">&#40;</span>Colors<span style="color: #008000;">.</span><span style="color: #0000FF;">Red</span><span style="color: #008000;">&#41;</span>,
    Width <span style="color: #008000;">=</span> width,
    Height <span style="color: #008000;">=</span> height
  <span style="color: #008000;">&#125;</span><span style="color: #008000;">;</span>
  Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">SetLeft</span><span style="color: #008000;">&#40;</span>rec, x1<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">SetTop</span><span style="color: #008000;">&#40;</span>rec, y1<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  mazeContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">Children</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">&#40;</span>rec<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&nbsp;
  AddPhysicsBody<span style="color: #008000;">&#40;</span>rec, <span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<p>A bit messy, but gets the job done!</p>
<p>The above code creates a maze comprised of static physics objects, where the<code> _mazeSize</code> field dictates the scale of the maze:</p>
<p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/12/Mazes.png" alt="" title="Mazes" width="500" height="454" class="aligncenter size-full wp-image-1902" /></p>
<h2>Adding a Rolling Ball</h2>
<p>Adding a ball to the maze is simply a matter of creating an ellipse and adding it at the maze entrance. Note, this physics-body is not static, so will move under the influence of gravity:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}Ellipse ball <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> Ellipse<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  Width <span style="color: #008000;">=</span> cellWidth <span style="color: #008000;">*</span> <span style="color: #FF0000;">0.7</span>,
  Height <span style="color: #008000;">=</span> cellWidth <span style="color: #008000;">*</span> <span style="color: #FF0000;">0.7</span>,
  Fill <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Resources</span><span style="color: #008000;">&#91;</span><span style="color: #666666;">&quot;brush&quot;</span><span style="color: #008000;">&#93;</span> <span style="color: #0600FF; font-weight: bold;">as</span> Brush
<span style="color: #008000;">&#125;</span><span style="color: #008000;">;</span>
Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">SetLeft</span><span style="color: #008000;">&#40;</span>ball, <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span>cols <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">+</span> <span style="color: #FF0000;">0.7</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">*</span> cellWidth<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">SetTop</span><span style="color: #008000;">&#40;</span>ball, <span style="color: #FF0000;">0</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
mazeContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">Children</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">&#40;</span>ball<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&nbsp;
AddPhysicsBody<span style="color: #008000;">&#40;</span>ball, <span style="color: #0600FF; font-weight: bold;">false</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>{% endhighlight %}
</div>
</div>
<p>By default, the 'world' has gravity with a fixed Y component and no X component. This causes all non-static bodies to fall downwards as you might expect. In order to guide the ball around the maze by tilting the phone, we need to adjust gravity based on accelerometer readings. This is achieved by the following code:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> HandleAccelerometer<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  _sensor <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> Accelerometer<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  _sensor<span style="color: #008000;">.</span><span style="color: #0000FF;">Start</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// 10 times a second, update the gravity</span>
  var gtimer <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> DispatcherTimer<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  gtimer<span style="color: #008000;">.</span><span style="color: #0000FF;">Interval</span> <span style="color: #008000;">=</span> TimeSpan<span style="color: #008000;">.</span><span style="color: #0000FF;">FromSeconds</span><span style="color: #008000;">&#40;</span><span style="color: #FF0000;">0.1</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  gtimer<span style="color: #008000;">.</span><span style="color: #0000FF;">Tick</span> <span style="color: #008000;">+=</span> <span style="color: #008000;">&#40;</span>s, e<span style="color: #008000;">&#41;</span> <span style="color: #008000;">=&gt;</span>
  <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>_physicsController<span style="color: #008000;">.</span><span style="color: #0000FF;">Simulator</span> <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
      _physicsController<span style="color: #008000;">.</span><span style="color: #0000FF;">Simulator</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Gravity</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Y</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">5</span> <span style="color: #008000;">*</span> <span style="color: #008000;">-</span>_sensor<span style="color: #008000;">.</span><span style="color: #0000FF;">CurrentValue</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Acceleration</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Y</span><span style="color: #008000;">;</span>
      _physicsController<span style="color: #008000;">.</span><span style="color: #0000FF;">Simulator</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Gravity</span><span style="color: #008000;">.</span><span style="color: #0000FF;">X</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">5</span> <span style="color: #008000;">*</span> _sensor<span style="color: #008000;">.</span><span style="color: #0000FF;">CurrentValue</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Acceleration</span><span style="color: #008000;">.</span><span style="color: #0000FF;">X</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
  <span style="color: #008000;">&#125;</span><span style="color: #008000;">;</span>
  gtimer<span style="color: #008000;">.</span><span style="color: #0000FF;">Start</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<p><strong>Note</strong>: this uses a timer, rather than updating the simulator every time the accelerometer reading changes. I found that without the timer, I was repeatedly seeing the generic "Element is already a child of another element" exception. You will also notice in the code that the maze is built after a pause of a couple of seconds, again in order to avoid this issue. There's something funny going on inside the Physics Helper!</p>
<p>Finally, we handle collisions in order to play a simple sounds effect a the ball bounces off each wall:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #008080; font-style: italic;">// locate the physics controller</span>
_physicsController <span style="color: #008000;">=</span> mazeContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">GetValue</span><span style="color: #008000;">&#40;</span>PhysicsControllerMain<span style="color: #008000;">.</span><span style="color: #0000FF;">PhysicsControllerProperty</span><span style="color: #008000;">&#41;</span> <span style="color: #0600FF; font-weight: bold;">as</span> PhysicsControllerMain<span style="color: #008000;">;</span>
&nbsp;
<span style="color: #008080; font-style: italic;">// load the WAV file</span>
Stream stream <span style="color: #008000;">=</span> TitleContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">OpenStream</span><span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;boing1.wav&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
_effect <span style="color: #008000;">=</span> SoundEffect<span style="color: #008000;">.</span><span style="color: #0000FF;">FromStream</span><span style="color: #008000;">&#40;</span>stream<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
FrameworkDispatcher<span style="color: #008000;">.</span><span style="color: #0000FF;">Update</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&nbsp;
<span style="color: #008080; font-style: italic;">// play on each collision</span>
_physicsController<span style="color: #008000;">.</span><span style="color: #0000FF;">Collision</span> <span style="color: #008000;">+=</span> <span style="color: #008000;">&#40;</span>s,e<span style="color: #008000;">&#41;</span> <span style="color: #008000;">=&gt;</span> _effect<span style="color: #008000;">.</span><span style="color: #0000FF;">Play</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>{% endhighlight %}
</div>
</div>
<p>And there we have it, a simple maze game powered by the Farseer Physics engine. The whole thing only took about an hour to create, with code grabbed from the internet &#8211; a bit rough and ready, but I was impressed with how easy it was to create this game. There is much more that could be done, for example detecting when the ball reaches the end of the maze, advancing to a more difficult level, however, my time has run out on this bit of fun &#8230; Also, if I were to take this idea further, I would probably use XNA rather than Silverlight. The Physics Helper is great for simple XAML-only physics models, but I feel that it wasn't really built for programmatic creation of bodies.</p>
<p>You can download the code here: <a href='http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/12/WP7MazeGame.zip'>WP7MazeGame.zip</a></p>
<p>Note, you will have to download and install Physics Helper to run this code.</p>
<p>On another note, Farseer is clearly the result of hundreds of hours of development effort, which makes it easy to create realistic physics-based applications and games. Farseer is free to use under the MS-PL licence. However, I would urge anyone who has used this great library to create a WP7 game to donate via the <a href="http://farseerphysics.codeplex.com/">Farseer codeplex site</a> (scroll to the bottom).</p>
<p>Regards, Colin E.</p>
