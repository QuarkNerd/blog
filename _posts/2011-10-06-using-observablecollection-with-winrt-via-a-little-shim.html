---
id: 131332
author: Colin Eberhardt
tags: 
- cross-platform
categories: 
- Blog
layout: ceberhardt_post
---

<p><em>WInRT introduces a new interface for collection change notification, IObservableVector, which means ObservableCollection no longer works with this framework. In this blog post I will show how you can use ObservableCollection, via a simple adapter, within you WInRT applications.</em></p>
<div class="wp_syntax"><div class="code">{% highlight xml %}<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ItemsControl</span> <span style="color: #000066;">ItemsSource</span>=<span style="color: #ff0000;">&quot;{Binding Path=MyCollection, Converter={StaticResource ObservableCollectionAdapter}}&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>{% endhighlight %}
</div>
</div>
<p>Developers are slowly starting to get their heads around the differences between the old (Silverlight, WPF, WP7) and the new - WinRT. Whilst the it has a familiar feel, with the UI defined in XAML and an API that is very similar to .NET, there are a great many differences. For an overview of some of these differences see:</p>
<ul>
<li><a href="http://www.scottlogic.co.uk/blog/colin/2011/09/tweetsearch-a-cross-platform-metro-ui-winrt-and-silverlight-application/">TweetSearch</a> - A Cross platform Metro UI WinRT</li>
<li>Morten Nielsen's blog series on <a href="http://www.sharpgis.net/post/2011/09/15/WinRT-vs-Silverlight-Part-0.aspx">WInRT vs. Silverlight differences</a></li>
</ul>
<p>A number of <a href="http://social.msdn.microsoft.com/Forums/en-AU/winappswithcsharp/thread/054913c2-6ad4-4b54-a349-c7ae846d4f8e">developers have discovered</a> that while WinRT has the <code>ObservableCollection</code> class, when bound to the UI, lists / grids fail to update as items are added / removed. This is because while the same interfaces are being used for collections (<code>ILIst</code>, <code>IEnumerable</code> etc &#8230;), there is a new interface for notification of collection changes, <code>IObservableVector</code>. Because <code>ObservableCollection </code>implements <code>IEnumerable </code>its contents will be rendered in the UI, however it implements the 'old' interface for change notification - <code>INotifyCollectionChanged</code>.</p>
<p>The WinRT SDK samples include classes that implement <code>IObservableVector </code>to demonstrate binding with collection change handling, however, what if you have some old code using <code>ObservableCollection</code> that you want to port over? Or, what if you want to code-share between Silverlight and WInRT?</p>
<p>A few days ago I saw a blog post by Avi Pilosof where he <a href="http://blogs.msdn.com/b/avip/archive/2011/09/18/windows-8-development-tidbits-observablecollection-doesn-t-work.aspx">created a class that implements both the INotifyCollectionChanged and IObservableVector interfaces</a>. This will certainly do the job, however there is a simpler way &#8230;</p>
<p>Using the Gang of Four Adapter pattern, we can create a class which wraps <code>ObservableCollection</code>, to implement <code>IObservableVector</code>:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Adapts an ObservableCollection to implement IObservableVector</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> ObservableCollectionShim<span style="color: #008000;">&lt;</span>T<span style="color: #008000;">&gt;</span> <span style="color: #008000;">:</span> IObservableVector<span style="color: #008000;">&lt;</span>T<span style="color: #008000;">&gt;</span>
<span style="color: #008000;">&#123;</span>
  <span style="color: #0600FF; font-weight: bold;">private</span> ObservableCollection<span style="color: #008000;">&lt;</span>T<span style="color: #008000;">&gt;</span> _adaptee<span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">public</span> ObservableCollectionShim<span style="color: #008000;">&#40;</span>ObservableCollection<span style="color: #008000;">&lt;</span>T<span style="color: #008000;">&gt;</span> adaptee<span style="color: #008000;">&#41;</span>
  <span style="color: #008000;">&#123;</span>
    _adaptee <span style="color: #008000;">=</span> adaptee<span style="color: #008000;">;</span>
    _adaptee<span style="color: #008000;">.</span><span style="color: #0000FF;">CollectionChanged</span> <span style="color: #008000;">+=</span> Adaptee_CollectionChanged<span style="color: #008000;">;</span>
  <span style="color: #008000;">&#125;</span>
  <span style="color: #008000;">...</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<p><code>IObservableVector </code>extends various list interfaces (ILIst etc &#8230;) so we have to implement these on <code>ObservableCollectionShim</code> via straight-through adapter methods &#8230;</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">int</span> IndexOf<span style="color: #008000;">&#40;</span>T item<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  <span style="color: #0600FF; font-weight: bold;">return</span> _adaptee<span style="color: #008000;">.</span><span style="color: #0000FF;">IndexOf</span><span style="color: #008000;">&#40;</span>item<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> Insert<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">int</span> index, T item<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  _adaptee<span style="color: #008000;">.</span><span style="color: #0000FF;">Insert</span><span style="color: #008000;">&#40;</span>index, item<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> RemoveAt<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">int</span> index<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  _adaptee<span style="color: #008000;">.</span><span style="color: #0000FF;">RemoveAt</span><span style="color: #008000;">&#40;</span>index<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span>
&nbsp;
<span style="color: #008080; font-style: italic;">// etc ...</span>{% endhighlight %}
</div>
</div>
<p>Now, the interesting part! The change notification is implemented by handling <code>CollectionChanged </code>events, and re-emitting them as <code>VectorChanged </code>events:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Handles and adapts CollectionChanged events</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Adaptee_CollectionChanged<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, NotifyCollectionChangedEventArgs e<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
  VectorChangedEventArgs args <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> VectorChangedEventArgs<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">switch</span> <span style="color: #008000;">&#40;</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">Action</span><span style="color: #008000;">&#41;</span>
  <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">case</span> NotifyCollectionChangedAction<span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">:</span>
      args<span style="color: #008000;">.</span><span style="color: #0000FF;">CollectionChange</span> <span style="color: #008000;">=</span> CollectionChange<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemInserted</span><span style="color: #008000;">;</span>
      args<span style="color: #008000;">.</span><span style="color: #0000FF;">Index</span> <span style="color: #008000;">=</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">uint</span><span style="color: #008000;">&#41;</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">NewStartingIndex</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">case</span> NotifyCollectionChangedAction<span style="color: #008000;">.</span><span style="color: #0000FF;">Remove</span><span style="color: #008000;">:</span>
      args<span style="color: #008000;">.</span><span style="color: #0000FF;">CollectionChange</span> <span style="color: #008000;">=</span> CollectionChange<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemRemoved</span><span style="color: #008000;">;</span>
      args<span style="color: #008000;">.</span><span style="color: #0000FF;">Index</span> <span style="color: #008000;">=</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">uint</span><span style="color: #008000;">&#41;</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">OldStartingIndex</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">case</span> NotifyCollectionChangedAction<span style="color: #008000;">.</span><span style="color: #0000FF;">Replace</span><span style="color: #008000;">:</span>
      args<span style="color: #008000;">.</span><span style="color: #0000FF;">CollectionChange</span> <span style="color: #008000;">=</span> CollectionChange<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemChanged</span><span style="color: #008000;">;</span>
      args<span style="color: #008000;">.</span><span style="color: #0000FF;">Index</span> <span style="color: #008000;">=</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">uint</span><span style="color: #008000;">&#41;</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">NewStartingIndex</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">case</span> NotifyCollectionChangedAction<span style="color: #008000;">.</span><span style="color: #0000FF;">Reset</span><span style="color: #008000;">:</span>
    <span style="color: #0600FF; font-weight: bold;">case</span> NotifyCollectionChangedAction<span style="color: #008000;">.</span><span style="color: #0000FF;">Move</span><span style="color: #008000;">:</span>
      args<span style="color: #008000;">.</span><span style="color: #0000FF;">CollectionChange</span> <span style="color: #008000;">=</span> CollectionChange<span style="color: #008000;">.</span><span style="color: #0000FF;">Reset</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
  OnVectorChanged<span style="color: #008000;">&#40;</span>args<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<p>Note, there does not seem to be an equivalent for <code>NotifyCollectionChangedAction.Move</code>, however, I am pretty sure <code>ObservableCollection</code> never raises that change type anyway!</p>
<p>We can now make use of our 'shim' class within a view-model as follows:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #0600FF; font-weight: bold;">private</span> ObservableCollection<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&gt;</span> _items<span style="color: #008000;">;</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">public</span> IObservableVector<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&gt;</span> Items
<span style="color: #008000;">&#123;</span>
  get
  <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">return</span>  <span style="color: #008000;">new</span> ObservableCollectionShim<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&gt;</span>_items<span style="color: #008000;">;</span>
  <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<p>However, if we were using this view-model within a cross-platform application, this would still cause problems, because <code>IObservableCollection </code>does not exist in Silveright / WPF. A more elegant solution is to wrap the <code>ObservableCollection </code>in the shim class within a value converter. Firstly, we need a way to create a shim without specifying the generic type argument (<code>IValueConverter </code>is not strongly typed, your bound values are presented as the type 'object'):</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">class</span> ExtensionMethods
<span style="color: #008000;">&#123;</span>
  <span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
  <span style="color: #008080; font-style: italic;">/// Creates an ObservableCollectionShim that adapts this ObservableCollection.</span>
  <span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">object</span> ToObservableVector<span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">this</span> INotifyCollectionChanged collection<span style="color: #008000;">&#41;</span>
  <span style="color: #008000;">&#123;</span>
    Type genericItemType <span style="color: #008000;">=</span> collection<span style="color: #008000;">.</span><span style="color: #0000FF;">GetType</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GenericTypeArguments</span><span style="color: #008000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #008000;">&#93;</span><span style="color: #008000;">;</span>
    Type shimType <span style="color: #008000;">=</span> <span style="color: #008000;">typeof</span><span style="color: #008000;">&#40;</span>ObservableCollectionShim<span style="color: #008000;">&lt;&gt;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    Type genericShimType <span style="color: #008000;">=</span> shimType<span style="color: #008000;">.</span><span style="color: #0000FF;">MakeGenericType</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">new</span> Type<span style="color: #008000;">&#91;</span><span style="color: #008000;">&#93;</span> <span style="color: #008000;">&#123;</span> genericItemType <span style="color: #008000;">&#125;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">return</span> Activator<span style="color: #008000;">.</span><span style="color: #0000FF;">CreateInstance</span><span style="color: #008000;">&#40;</span>genericShimType, <span style="color: #008000;">new</span> <span style="color: #6666cc; font-weight: bold;">object</span><span style="color: #008000;">&#91;</span><span style="color: #008000;">&#93;</span> <span style="color: #008000;">&#123;</span> collection <span style="color: #008000;">&#125;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<p>This can then be used within a value converter as follows:</p>
<div class="wp_syntax"><div class="code">{% highlight csharp %}<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> ObservableCollectionAdapter <span style="color: #008000;">:</span> IValueConverter
<span style="color: #008000;">&#123;</span>
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> Convert<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> value, <span style="color: #6666cc; font-weight: bold;">string</span> typeName, <span style="color: #6666cc; font-weight: bold;">object</span> parameter, <span style="color: #6666cc; font-weight: bold;">string</span> language<span style="color: #008000;">&#41;</span>
  <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span>INotifyCollectionChanged<span style="color: #008000;">&#41;</span>value<span style="color: #008000;">&#41;</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ToObservableVector</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">&#125;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> ConvertBack<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> value, <span style="color: #6666cc; font-weight: bold;">string</span> typeName, <span style="color: #6666cc; font-weight: bold;">object</span> parameter, <span style="color: #6666cc; font-weight: bold;">string</span> language<span style="color: #008000;">&#41;</span>
  <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">throw</span> <span style="color: #008000;">new</span> NotImplementedException<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span>{% endhighlight %}
</div>
</div>
<p>This allows us to adapt an <code>ObservableCollection</code> for use with WinRT simply by applying a value-converter within the View:</p>
<div class="wp_syntax"><div class="code">{% highlight xml %}<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ItemsControl</span> <span style="color: #000066;">ItemsSource</span>=<span style="color: #ff0000;">&quot;{Binding Path=MyCollection, Converter={StaticResource ObservableCollectionAdapter}}&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>{% endhighlight %}
</div>
</div>
<p>A nice side-effect of this approach is that if we replace the <code>ObservableCollection </code>within our view-model with a new instance, the binding framework will take care of creating a new 'shim' via the value converter.</p>
<p>This technique allows us to write cross-platform view-models using <code>ObservableCollection</code> for our collections of objects.</p>
<p>You can download the sourcecode with a simple example here: <a href='http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/10/ObservableCollectionShim.zip'>ObservableCollectionShim.zip</a></p>
<p>Regards, Colin E.</p>
